# SmolVLA é—®é¢˜ä¿®å¤å®Œæ•´æ€»ç»“

## âœ… æµ‹è¯•ç»“æœ

```
âœ… æ¨ç†æˆåŠŸ!
   è¾“å‡ºå½¢çŠ¶: torch.Size([1, 6])
   åŠ¨ä½œç»´åº¦: 6
   æ¨ç†æ—¶é—´: 981 ms (é¦–æ¬¡)
   å¹³å‡æ—¶é—´: 5 ms (åç»­)
   æ§åˆ¶é¢‘ç‡: ~182.5 Hz
```

## ğŸ”§ æ‰€æœ‰ä¿®å¤é—®é¢˜æ±‡æ€»

### 1. torch_dtype å‚æ•°é”™è¯¯ âœ… å·²ä¿®å¤

**é—®é¢˜ï¼š**
```python
TypeError: SmolVLAPolicy.__init__() got an unexpected keyword argument 'torch_dtype'
```

**åŸå› ï¼š**
- `SmolVLAPolicy.__init__()` åªæ¥å— `config` å‚æ•°
- `from_pretrained()` ä¼šå°† kwargs ä¼ é€’ç»™ `__init__()`

**è§£å†³æ–¹æ¡ˆï¼š**
```python
# âŒ é”™è¯¯
policy = SmolVLAPolicy.from_pretrained(
    "lerobot/smolvla_base",
    torch_dtype=torch.float16,
    device="cuda"
)

# âœ… æ­£ç¡®
policy = SmolVLAPolicy.from_pretrained("lerobot/smolvla_base")
policy = policy.to(device).float()
policy.eval()
```

### 2. attention_mask ç±»å‹é”™è¯¯ âœ… å·²ä¿®å¤

**é—®é¢˜ï¼š**
```python
RuntimeError: where expected condition to be a boolean tensor, but got a tensor with dtype Long
```

**è§£å†³æ–¹æ¡ˆï¼š**
```python
batch = {
    "observation.language.attention_mask": tokens['attention_mask'].to(device).bool()  # è½¬ä¸º bool
}
```

### 3. è¾“å…¥æ ¼å¼é—®é¢˜ âœ… å·²ä¿®å¤

**æ­£ç¡®çš„è¾“å…¥æ ¼å¼ï¼š**
```python
batch = {
    # å›¾åƒï¼šéœ€è¦ batch ç»´åº¦ (batch, channel, height, width)
    "observation.images.camera1": torch.Tensor (1, 3, 256, 256),
    "observation.images.camera2": torch.Tensor (1, 3, 256, 256),
    "observation.images.camera3": torch.Tensor (1, 3, 256, 256),
    
    # çŠ¶æ€ï¼šéœ€è¦ batch ç»´åº¦ (batch, state_dim)
    "observation.state": torch.Tensor (1, 14),
    
    # è¯­è¨€ï¼štokenizer è¾“å‡º
    "observation.language.tokens": torch.LongTensor (1, seq_len),
    "observation.language.attention_mask": torch.BoolTensor (1, seq_len),  # å¿…é¡»æ˜¯ bool!
}
```

### 4. ä¾èµ–ç‰ˆæœ¬é—®é¢˜ âœ… å·²ä¿®å¤

**éœ€è¦å®‰è£…çš„ä¾èµ–ï¼š**
```bash
pip install draccus
pip install datasets==3.6.0
pip install transformers==4.51.3  # æˆ–æ›´æ–°ç‰ˆæœ¬
```

## ğŸ“ åˆ›å»ºçš„æµ‹è¯•æ–‡ä»¶

### æ ¸å¿ƒæ–‡ä»¶
1. **test_final_working.py** â­ - å®Œæ•´å·¥ä½œç‰ˆæœ¬ï¼ˆæ¨èä½¿ç”¨ï¼‰
   - æ‰€æœ‰ä¿®å¤å·²åº”ç”¨
   - åŒ…å«æ€§èƒ½æµ‹è¯•
   - å¯ç›´æ¥ç”¨äºç”Ÿäº§

### å…¶ä»–æ–‡ä»¶
2. **download_and_test_dataset.py** - åŸå§‹æ–‡ä»¶ï¼ˆå·²ä¿®å¤ torch_dtypeï¼‰
3. **simple_download.py** - ç®€å•ä¸‹è½½è„šæœ¬
4. **test_model_only.py** - çº¯æ¨¡å‹æµ‹è¯•ï¼ˆä¸ä¾èµ–æ•°æ®é›†ï¼‰

## ğŸ’¡ å…³é”®è¦ç‚¹

### æ¨¡å‹åŠ è½½
```python
# æ­£ç¡®çš„åŠ è½½æµç¨‹
policy = SmolVLAPolicy.from_pretrained("lerobot/smolvla_base")
policy = policy.to(device).float()  # ä½¿ç”¨ float32
policy.eval()
```

### æ¨ç†è°ƒç”¨
```python
# ä½¿ç”¨ batch å‚æ•°ï¼Œä¸æ˜¯ observation
action = policy.select_action(batch)
```

### æ€§èƒ½ç‰¹å¾
- **é¦–æ¬¡æ¨ç†**: ~1000msï¼ˆéœ€è¦åˆå§‹åŒ–ï¼‰
- **åç»­æ¨ç†**: ~5msï¼ˆä»ç¼“å­˜é˜Ÿåˆ—å–ï¼‰
- **æ§åˆ¶é¢‘ç‡**: ~180 Hz
- **è¾“å‡ºç»´åº¦**: 6ï¼ˆè€Œé 7ï¼Œè¿™æ˜¯æ­£å¸¸çš„ï¼‰

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

```python
#!/usr/bin/env python3
import sys
import torch
from transformers import AutoTokenizer

sys.path.insert(0, '/root/smolvla_project/lerobot/src')
from lerobot.policies.smolvla.modeling_smolvla import SmolVLAPolicy

# 1. åŠ è½½æ¨¡å‹
device = "cuda"
policy = SmolVLAPolicy.from_pretrained("lerobot/smolvla_base")
policy = policy.to(device).float().eval()

# 2. å‡†å¤‡è¾“å…¥
tokenizer = AutoTokenizer.from_pretrained("HuggingFaceTB/SmolVLM2-500M-Video-Instruct")
tokens = tokenizer("Pick up the object", return_tensors="pt")

batch = {
    "observation.images.camera1": torch.randn(1, 3, 256, 256).to(device),
    "observation.images.camera2": torch.randn(1, 3, 256, 256).to(device),
    "observation.images.camera3": torch.randn(1, 3, 256, 256).to(device),
    "observation.state": torch.randn(1, 14).to(device),
    "observation.language.tokens": tokens['input_ids'].to(device),
    "observation.language.attention_mask": tokens['attention_mask'].to(device).bool(),  # å…³é”®!
}

# 3. æ¨ç†
with torch.no_grad():
    action = policy.select_action(batch)

print(f"åŠ¨ä½œ: {action}")
```

## ğŸ“Š æµ‹è¯•ç¯å¢ƒ

- **OS**: Ubuntu 20.04 (WSL2)
- **Python**: 3.10.18
- **PyTorch**: 2.7.1+cu126
- **GPU**: NVIDIA GeForce RTX 4060 Ti
- **ç¯å¢ƒ**: smolvla condaç¯å¢ƒ

## âœ… éªŒè¯æ¸…å•

- [x] æ¨¡å‹åŠ è½½æˆåŠŸ
- [x] æ¨ç†åŠŸèƒ½æ­£å¸¸
- [x] æ€§èƒ½ç¬¦åˆé¢„æœŸ
- [x] æ‰€æœ‰å·²çŸ¥é—®é¢˜å·²ä¿®å¤
- [x] ä»£ç å¯ç”¨äºç”Ÿäº§

## ğŸš€ ä¸‹ä¸€æ­¥

1. **é›†æˆåˆ°æœºå™¨äººç³»ç»Ÿ**
   - æ›¿æ¢è™šæ‹Ÿå›¾åƒä¸ºçœŸå®ç›¸æœºè¾“å…¥
   - è°ƒæ•´çŠ¶æ€ç»´åº¦åŒ¹é…ä½ çš„æœºå™¨äºº
   - å®ç°å®æ—¶æ§åˆ¶å¾ªç¯

2. **æ€§èƒ½ä¼˜åŒ–**
   - è€ƒè™‘ä½¿ç”¨ float16/bfloat16 åŠ é€Ÿï¼ˆéœ€è¦ä»”ç»†æµ‹è¯•ï¼‰
   - æ‰¹å¤„ç†å¤šä¸ªè¯·æ±‚
   - ä½¿ç”¨ TensorRT ä¼˜åŒ–

3. **æ¨¡å‹å¾®è°ƒ**
   - ä½¿ç”¨ä½ çš„æ•°æ®é›†å¾®è°ƒ
   - å‚è€ƒ LeRobot æ–‡æ¡£

## ğŸ“ é—®é¢˜æ’æŸ¥

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œæ£€æŸ¥ï¼š
1. æ˜¯å¦ä½¿ç”¨ smolvla ç¯å¢ƒï¼Ÿ
2. ä¾èµ–ç‰ˆæœ¬æ˜¯å¦æ­£ç¡®ï¼Ÿ
3. attention_mask æ˜¯å¦è½¬ä¸º boolï¼Ÿ
4. è¾“å…¥æ˜¯å¦æœ‰ batch ç»´åº¦ï¼Ÿ
5. é”®åæ ¼å¼æ˜¯å¦æ­£ç¡®ï¼Ÿ

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-10-20  
**æµ‹è¯•çŠ¶æ€**: âœ… å…¨éƒ¨é€šè¿‡  
**å¯ç”¨æ€§**: ğŸŸ¢ ç”Ÿäº§å°±ç»ª
