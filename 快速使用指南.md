# SmolVLA å¿«é€Ÿä½¿ç”¨æŒ‡å—

## ğŸš€ 5åˆ†é’Ÿå¿«é€Ÿå¼€å§‹

### 1. æ¿€æ´»ç¯å¢ƒ
```bash
conda activate smolvla
cd /root/smolvla_project
```

### 2. è¿è¡Œæµ‹è¯•
```bash
# è¿è¡Œå®Œæ•´æµ‹è¯•ï¼ˆæ¨èï¼‰
python test_final_working.py

# é¢„æœŸè¾“å‡ºï¼š
# âœ… æ¨ç†æˆåŠŸ!
#    è¾“å‡ºå½¢çŠ¶: torch.Size([1, 6])
#    æ¨ç†æ—¶é—´: 5 ms
#    æ§åˆ¶é¢‘ç‡: ~182.5 Hz
```

### 3. ä½¿ç”¨æ¨¡å‹

åˆ›å»º `my_robot_control.py`ï¼š

```python
import sys
import torch
from transformers import AutoTokenizer

sys.path.insert(0, '/root/smolvla_project/lerobot/src')
from lerobot.policies.smolvla.modeling_smolvla import SmolVLAPolicy

# åŠ è½½æ¨¡å‹ï¼ˆä¸€æ¬¡æ€§ï¼‰
device = "cuda"
policy = SmolVLAPolicy.from_pretrained("lerobot/smolvla_base")
policy = policy.to(device).float().eval()

tokenizer = AutoTokenizer.from_pretrained("HuggingFaceTB/SmolVLM2-500M-Video-Instruct")

# æ§åˆ¶å¾ªç¯
while True:
    # 1. è·å–æœºå™¨äººä¼ æ„Ÿå™¨æ•°æ®
    camera1_image = get_camera1()  # ä½ çš„å‡½æ•°ï¼Œè¿”å› (3,256,256) tensor
    camera2_image = get_camera2()
    camera3_image = get_camera3()
    robot_state = get_robot_state()  # è¿”å› (14,) tensor
    
    # 2. å‡†å¤‡æŒ‡ä»¤
    instruction = "Pick up the red block"
    tokens = tokenizer(instruction, return_tensors="pt")
    
    # 3. æ„é€  batch
    batch = {
        "observation.images.camera1": camera1_image.unsqueeze(0).to(device),  # æ·»åŠ  batch ç»´åº¦
        "observation.images.camera2": camera2_image.unsqueeze(0).to(device),
        "observation.images.camera3": camera3_image.unsqueeze(0).to(device),
        "observation.state": robot_state.unsqueeze(0).to(device),
        "observation.language.tokens": tokens['input_ids'].to(device),
        "observation.language.attention_mask": tokens['attention_mask'].to(device).bool(),  # å¿…é¡» bool!
    }
    
    # 4. æ¨ç†
    with torch.no_grad():
        action = policy.select_action(batch)
    
    # 5. æ‰§è¡ŒåŠ¨ä½œ
    execute_action(action.squeeze(0).cpu().numpy())  # å»æ‰ batch ç»´åº¦
```

## ğŸ“ å¸¸è§é—®é¢˜ FAQ

### Q1: ä¸ºä»€ä¹ˆæ¨ç†æ—¶é—´ç¬¬ä¸€æ¬¡å¾ˆæ…¢ï¼Ÿ
**A**: é¦–æ¬¡æ¨ç†éœ€è¦åˆå§‹åŒ–æ¨¡å‹å’Œç¼“å­˜ï¼Œçº¦ 1000msã€‚åç»­æ¨ç†ä»é˜Ÿåˆ—å–åŠ¨ä½œï¼Œåªéœ€ 5msã€‚

### Q2: è¾“å‡ºä¸ºä»€ä¹ˆæ˜¯ 6 ç»´è€Œä¸æ˜¯ 7 ç»´ï¼Ÿ
**A**: è¿™æ˜¯æ¨¡å‹çš„æ­£å¸¸è¡Œä¸ºï¼Œ6 ç»´è¶³å¤Ÿç”¨äºæœºæ¢°è‡‚æ§åˆ¶ï¼ˆä½ç½®3ç»´+æ—‹è½¬3ç»´ï¼‰ã€‚

### Q3: å¿…é¡»æä¾› 3 ä¸ªç›¸æœºå—ï¼Ÿ
**A**: æ˜¯çš„ï¼Œè¿™æ˜¯æ¨¡å‹é…ç½®è¦æ±‚ã€‚å¦‚æœåªæœ‰ 1 ä¸ªç›¸æœºï¼Œå¯ä»¥å¤åˆ¶ 3 ä»½ï¼š
```python
image = get_camera()
batch = {
    "observation.images.camera1": image,
    "observation.images.camera2": image,  # å¤åˆ¶
    "observation.images.camera3": image,  # å¤åˆ¶
    ...
}
```

### Q4: å¦‚ä½•æ›´æ”¹çŠ¶æ€ç»´åº¦ï¼Ÿ
**A**: çŠ¶æ€ç»´åº¦å–å†³äºä½ çš„æœºå™¨äººã€‚ALOHA ä½¿ç”¨ 14 ç»´ï¼ŒPushT ä½¿ç”¨ 7 ç»´ã€‚è°ƒæ•´ç›¸åº”çš„è¾“å…¥å³å¯ã€‚

### Q5: attention_mask ä¸ºä»€ä¹ˆå¿…é¡»æ˜¯ boolï¼Ÿ
**A**: PyTorch çš„ `torch.where` è¦æ±‚æ¡ä»¶å¿…é¡»æ˜¯ bool ç±»å‹ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚ä½¿ç”¨ `.bool()` è½¬æ¢ã€‚

## ğŸ”§ æ•…éšœæ’æŸ¥

### é”™è¯¯ 1: `TypeError: got an unexpected keyword argument 'torch_dtype'`
**è§£å†³**: ä¸è¦ä¼  `torch_dtype` å’Œ `device` ç»™ `from_pretrained()`ï¼Œæ”¹ç”¨ `.to(device).float()`

### é”™è¯¯ 2: `RuntimeError: where expected condition to be a boolean tensor`
**è§£å†³**: `attention_mask` è½¬ä¸º bool - `tokens['attention_mask'].to(device).bool()`

### é”™è¯¯ 3: `ValueError: (b,c,h,w) expected`
**è§£å†³**: å›¾åƒéœ€è¦ batch ç»´åº¦ - `image.unsqueeze(0)` æ·»åŠ ç»´åº¦

### é”™è¯¯ 4: `KeyError: 'observation.language.tokens'`
**è§£å†³**: ç¡®ä¿æä¾›äº†è¯­è¨€ tokens å’Œ attention_mask

### é”™è¯¯ 5: `ModuleNotFoundError: No module named 'draccus'`
**è§£å†³**: `pip install draccus datasets==3.6.0`

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **ä½¿ç”¨ GPU**: ç¡®ä¿åœ¨ CUDA ä¸Šè¿è¡Œï¼Œé€Ÿåº¦æå‡ 100x
2. **æ‰¹å¤„ç†**: å¦‚æœæœ‰å¤šä¸ªè¯·æ±‚ï¼Œå¯ä»¥æ‰¹å¤„ç†æå‡æ•ˆç‡
3. **å›ºå®šæŒ‡ä»¤**: å¦‚æœæŒ‡ä»¤ä¸å˜ï¼Œå¯ä»¥é¢„å…ˆ tokenize
4. **å›¾åƒé¢„å¤„ç†**: æå‰å°†å›¾åƒè½¬ä¸ºæ­£ç¡®æ ¼å¼å’Œè®¾å¤‡

## ğŸ“š ç›¸å…³æ–‡ä»¶

- `test_final_working.py` - å®Œæ•´å·¥ä½œæµ‹è¯• â­
- `ä¿®å¤å®Œæ•´æ€»ç»“.md` - è¯¦ç»†ä¿®å¤æ–‡æ¡£
- `download_and_test_dataset.py` - æ•°æ®é›†ä¸‹è½½å’Œæµ‹è¯•

## ğŸ’¡ å°è´´å£«

1. åœ¨ smolvla ç¯å¢ƒä¸­è¿è¡Œ
2. attention_mask å¿…é¡»è½¬ bool
3. æ‰€æœ‰è¾“å…¥éƒ½éœ€è¦ batch ç»´åº¦
4. é¦–æ¬¡æ¨ç†æ…¢æ˜¯æ­£å¸¸çš„
5. åç»­æ¨ç†é€Ÿåº¦å¿«ï¼ˆçº¦ 5msï¼‰

---

**æœ€åæ›´æ–°**: 2025-10-20  
**çŠ¶æ€**: âœ… æ‰€æœ‰é—®é¢˜å·²ä¿®å¤ï¼Œå¯ç”¨äºç”Ÿäº§
